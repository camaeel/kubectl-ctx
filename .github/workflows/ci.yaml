name: CI

on:
  push:
    branches: 
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches: 
      - main
      - master

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-tags: true
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: './go.mod'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'

  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        command:
          - kubectl-ctx
          - kubectl-ns
        goos:
          - linux
          - darwin
          - windows
        goarch:
          - amd64
          - arm64
        exclude:
          - goos: windows
            goarch: arm64
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Build ${{ matrix.command }}
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p bin
          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi
          go build -v -ldflags="-s -w -X main.Version=${{ github.ref_name }}" -o "bin/${{ matrix.command }}-${GOOS}-${GOARCH}${EXT}" ./cmd/${{ matrix.command }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: binaries-${{ matrix.command }}-${{ matrix.goos }}-${{ matrix.goarch }}
          path: bin/*

  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [test, lint, security, build]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum ./* > SHA256SUMS
          cd ..

      - name: Upload to existing release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*

  update-homebrew:
    runs-on: ubuntu-latest
    needs: upload-release-assets
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout kubectl-ctx
        uses: actions/checkout@v6

      - name: Get release info
        id: release
        run: |
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "version_number=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download release assets and calculate checksums
        id: checksums
        run: |
          VERSION="${{ github.ref_name }}"
          
          # Download SHA256SUMS file from release
          curl -L "https://github.com/camaeel/kubectl-ctx/releases/download/${VERSION}/SHA256SUMS" -o SHA256SUMS
          
          # Extract checksums for each binary
          echo "ctx_darwin_amd64=$(grep 'kubectl-ctx-darwin-amd64$' SHA256SUMS | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "ctx_darwin_arm64=$(grep 'kubectl-ctx-darwin-arm64$' SHA256SUMS | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "ctx_linux_amd64=$(grep 'kubectl-ctx-linux-amd64$' SHA256SUMS | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "ctx_linux_arm64=$(grep 'kubectl-ctx-linux-arm64$' SHA256SUMS | awk '{print $1}')" >> $GITHUB_OUTPUT
          
          echo "ns_darwin_amd64=$(grep 'kubectl-ns-darwin-amd64$' SHA256SUMS | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "ns_darwin_arm64=$(grep 'kubectl-ns-darwin-arm64$' SHA256SUMS | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "ns_linux_amd64=$(grep 'kubectl-ns-linux-amd64$' SHA256SUMS | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "ns_linux_arm64=$(grep 'kubectl-ns-linux-arm64$' SHA256SUMS | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v6
        with:
          repository: camaeel/homebrew-tap
          path: homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Create Formula directory
        run: |
          mkdir -p homebrew-tap/Formula

      - name: Update kubectl-ctx formula
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUMBER="${VERSION#v}"
          cat > homebrew-tap/Formula/kubectl-ctx.rb << EOF
          class KubectlCtx < Formula
            desc "Kubernetes context and namespace switchers using client-go libraries"
            homepage "https://github.com/camaeel/kubectl-ctx"
            version "${VERSION_NUMBER}"
            license "Apache-2.0"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/camaeel/kubectl-ctx/releases/download/${VERSION}/kubectl-ctx-darwin-arm64"
                sha256 "${{ steps.checksums.outputs.ctx_darwin_arm64 }}"

                resource "kubectl-ns" do
                  url "https://github.com/camaeel/kubectl-ctx/releases/download/${VERSION}/kubectl-ns-darwin-arm64"
                  sha256 "${{ steps.checksums.outputs.ns_darwin_arm64 }}"
                end
              else
                url "https://github.com/camaeel/kubectl-ctx/releases/download/${VERSION}/kubectl-ctx-darwin-amd64"
                sha256 "${{ steps.checksums.outputs.ctx_darwin_amd64 }}"

                resource "kubectl-ns" do
                  url "https://github.com/camaeel/kubectl-ctx/releases/download/${VERSION}/kubectl-ns-darwin-amd64"
                  sha256 "${{ steps.checksums.outputs.ns_darwin_amd64 }}"
                end
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/camaeel/kubectl-ctx/releases/download/${VERSION}/kubectl-ctx-linux-arm64"
                sha256 "${{ steps.checksums.outputs.ctx_linux_arm64 }}"

                resource "kubectl-ns" do
                  url "https://github.com/camaeel/kubectl-ctx/releases/download/${VERSION}/kubectl-ns-linux-arm64"
                  sha256 "${{ steps.checksums.outputs.ns_darwin_arm64 }}"
                end
              else
                url "https://github.com/camaeel/kubectl-ctx/releases/download/${VERSION}/kubectl-ctx-linux-amd64"
                sha256 "${{ steps.checksums.outputs.ctx_linux_amd64 }}"

                resource "kubectl-ns" do
                  url "https://github.com/camaeel/kubectl-ctx/releases/download/${VERSION}/kubectl-ns-linux-amd64"
                  sha256 "${{ steps.checksums.outputs.ns_linux_amd64 }}"
                end
              end
            end

            def install
              os = OS.mac? ? "darwin" : "linux"
              arch = Hardware::CPU.arm? ? "arm64" : "amd64"
              suffix = "#{os}-#{arch}"

              bin.install "kubectl-ctx-#{suffix}" => "kubectl-ctx"

              resource("kubectl-ns").stage do
                bin.install "kubectl-ns-#{suffix}" => "kubectl-ns"
              end
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/kubectl-ctx --version")
              assert_match version.to_s, shell_output("#{bin}/kubectl-ns --version")
            end
          end
          EOF

      - name: Create PR with formula update
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH="update-kubectl-ctx-${{ github.ref_name }}"
          git checkout -b "$BRANCH"
          git add Formula/
          git commit -m "Update kubectl-ctx and kubectl-ns to ${{ github.ref_name }}"
          git push origin "$BRANCH"
          
          # Create PR and enable auto-merge
          gh pr create \
            --repo ${{ github.repository_owner }}/homebrew-tap \
            --base master \
            --head "$BRANCH" \
            --title "Update kubectl-ctx and kubectl-ns to ${{ github.ref_name }}" \
            --body "Automated update from kubectl-ctx release ${{ github.ref_name }}" \
            --assignee ${{ github.repository_owner }}
          
          # Enable auto-merge when checks pass (ignore errors if no required checks are configured)
          gh pr merge "$BRANCH" \
            --repo ${{ github.repository_owner }}/homebrew-tap \
            --auto \
            --squash || \
          gh pr edit "$BRANCH" \
            --repo ${{ github.repository_owner }}/homebrew-tap \
            --add-assignee ${{ github.repository_owner }}
